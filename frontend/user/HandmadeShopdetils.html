<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تفاصيل المتجر</title>
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/about.css" />
  </head>
  <body dir="rtl">
    <div class="top-bar">
      <div class="container d-flex justify-content-between flex-wrap">
        <div class="top-bar-left">
          <i class="fas fa-map-marker-alt"></i> الأردن، عجلون
          <i class="fas fa-envelope ms-3"></i> Ideamedia@gmail.com
        </div>
        <div class="top-bar-right d-flex align-items-center">
          <i class="fas fa-phone"></i>
          <a href="tel:+962791234567" class="text-ligth text-decoration-none"
            >0777956583</a
          >
          <span class="ms-3">تابعنا على:</span>
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-whatsapp"></i></a>
          <a href="#"><i class="fab fa-linkedin-in"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <span class="idea">أيديا</span>
          <span class="media">ميديا</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span><i class="fas fa-bars" style="color: orange"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Index.html">الرئيسية</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="coursesDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام الدورات
              </a>
              <ul
                id="categoriesDropdown"
                class="dropdown-menu"
                aria-labelledby="coursesDropdown"
              >
                <!-- سيتم إضافة الأقسام هنا -->
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المتجر
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/equipmentshop.html"
                    >متجر معدات</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/HandmadeShop.html"
                    >متجر منتجات يدوية</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/AllEvents.html"
                >كل الأحداث</a
              >
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المدربين
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/singupInstructors.html"
                  >
                    تسجيل كمدرب</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/ALLInstructors.html"
                    >كل المدربين</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Contact.html"
                >اتصل بنا</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/about.html">من نحن</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/admin/loginAdmin.html"
                >لوحة الإدارة</a
              >
            </li>
          </ul>
          <div class="icon-buttons d-flex align-items-center">
            <!-- زر تسجيل الدخول أو تسجيل الخروج بناءً على حالة تسجيل الدخول -->
            <div id="authLinks"></div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container mt-4">
      <div class="row">
        <div class="col-md-6 d-flex">
          <!-- الصورة الرئيسية -->
          <div class="flex-grow-1">
            <img
              id="mainImage"
              src=""
              class="img-fluid mb-2"
              alt="صورة المنتج الرئيسية"
              style="width: 100%; height: auto; cursor: pointer"
            />
          </div>

          <!-- الصور المصغرة -->
          <div class="d-flex flex-column justify-content-between">
            <img
              id="thumbnail1"
              src=""
              class="img-thumbnail mb-4 thumbnail"
              alt="صورة مصغرة 1"
              style="width: 150px; height: auto; cursor: pointer"
            />
            <img
              id="thumbnail2"
              src=""
              class="img-thumbnail mb-4 thumbnail"
              alt="صورة مصغرة 2"
              style="width: 150px; height: auto; cursor: pointer"
            />
            <img
              id="thumbnail3"
              src=""
              class="img-thumbnail mb-4 thumbnail"
              alt="صورة مصغرة 3"
              style="width: 150px; height: auto; cursor: pointer"
            />
          </div>
        </div>

        <!-- معلومات المنتج -->
        <div class="col-md-6">
          <h1 id="productName" class="mb-3"></h1>
          <p id="productPrice" class="h4 text-danger"></p>
          <p id="productRating" class="text-warning"></p>
          <p id="productDescription"></p>
          <div class="addcard">
            <a
              href="javascript:void(0);"
              class="btn btn-warning btn-lg w-100 mb-3"
              id="addToCartButtonHandmadeShopdetils"
              >شراء</a
            >
          </div>
        </div>
        <!-- صور المنتج -->
      </div>

      <!-- المنتجات ذات الصلة -->
      <div class="row mt-4" id="randomrelatedProducts"></div>
    </div>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-column">
            <h5>معلومات عنا</h5>
            <ul>
              <li><a href="#">قصتنا</a></li>
              <li><a href="#">الرؤية والرسالة</a></li>
              <li><a href="#">فريق العمل</a></li>
              <li><a href="#">الوظائف</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>روابط سريعة</h5>
            <ul>
              <li><a href="#">الرئيسية</a></li>
              <li><a href="#">المتجر</a></li>
              <li><a href="#">الأحداث</a></li>
              <li><a href="#">المدربون</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>تواصل معنا</h5>
            <ul>
              <li><a href="#">اتصل بنا</a></li>
              <li><a href="#">الأسئلة الشائعة</a></li>
              <li><a href="#">الدعم الفني</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2023 أيديا ميديا. جميع الحقوق محفوظة.</p>
        </div>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script>
      $(document).ready(function () {
        $(".thumbnail").on("click", function () {
          var src = $(this).attr("src");
          $("#mainImage").attr("src", src);
        });
      });
    </script>
    <!-- Bootstrap 5 Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="/frontend/user/javascript/ordelogin.js"></script>
    <script src="/frontend/user/ALLCategories.js"></script>
    <script>
      debugger;
      const API_BASE_URL = "http://localhost:38146/api";

      // استخراج ID المنتج من معلمات الـ URL
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id"); // تأكد أن الـ URL يحتوي على ?id=2 مثلاً
      debugger;
      // استدعاء بيانات المنتج من API
      fetch(`${API_BASE_URL}/Handmade_Products/${id}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          const defaultImage = `/backend/image/default.png`;

          // تعيين الصورة الرئيسية والصور المصغرة
          document.getElementById("mainImage").src = data.imageUrl1
            ? `/backend/image/${data.imageUrl1}`
            : defaultImage;
          document.getElementById("thumbnail1").src = data.imageUrl1
            ? `/backend/image/${data.imageUrl1}`
            : defaultImage;
          document.getElementById("thumbnail2").src = data.imageUrl2
            ? `/backend/image/${data.imageUrl2}`
            : defaultImage;
          document.getElementById("thumbnail3").src = data.imageUrl3
            ? `/backend/image/${data.imageUrl3}`
            : defaultImage;

          // إضافة وظائف لتغيير الصورة الرئيسية عند النقر على الصور المصغرة
          document
            .getElementById("thumbnail1")
            .addEventListener("click", function () {
              document.getElementById("mainImage").src = data.imageUrl1
                ? `/backend/image/${data.imageUrl1}`
                : defaultImage;
            });
          document
            .getElementById("thumbnail2")
            .addEventListener("click", function () {
              document.getElementById("mainImage").src = data.imageUrl2
                ? `/backend/image/${data.imageUrl2}`
                : defaultImage;
            });
          document
            .getElementById("thumbnail3")
            .addEventListener("click", function () {
              document.getElementById("mainImage").src = data.imageUrl3
                ? `/backend/image/${data.imageUrl3}`
                : defaultImage;
            });

          // تعيين معلومات المنتج
          document.getElementById("productName").textContent = data.name;
          document.getElementById(
            "productPrice"
          ).textContent = `${data.price} دينار`;
          document.getElementById("productRating").textContent =
            "★★★★★" + ` (${data.rating})`;
          document.getElementById("productDescription").textContent =
            data.description;
        })
        .catch((error) => {
          Swal.fire({
            title: "خطأ",
            text: "حدث خطأ أثناء استدعاء البيانات، يرجى المحاولة لاحقاً.",
            icon: "error",
          });
          console.error("Error fetching product data:", error);
        });

      // استدعاء بيانات المنتجات ذات الصلة من API
      fetch(`${API_BASE_URL}/Handmade_Products/random`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          const relatedProductsContainer = document.getElementById(
            "randomrelatedProducts"
          );

          // إنشاء العناصر لكل منتج
          data.forEach((product) => {
            const productHTML = `
        <div class="col-md-4 mb-4">
          <a href="javascript:void(0);" onclick="goToDetails15(${product.productId})" class="card text-decoration-none text-dark">
            <img src="/backend/image/${product.imageUrl1}" class="card-img-top img-fluid" alt="${product.name}" />
            <div class="card-body text-center">
              <h5 class="card-title">${product.name}</h5>
              <p class="card-text">${product.price} دينار</p>
              <p class="card-text">⭐⭐⭐⭐⭐ (${product.rating})</p>
            </div>
          </a>
        </div>`;
            relatedProductsContainer.innerHTML += productHTML;
          });
        })
        .catch((error) => {
          Swal.fire({
            title: "خطأ",
            text: "حدث خطأ أثناء استدعاء المنتجات ذات الصلة، يرجى المحاولة لاحقاً.",
            icon: "error",
          });
          console.error("Error fetching related products:", error);
        });

      function goToDetails15(productId) {
        localStorage.setItem("product_id", productId);
        window.location.href = `/frontend/user/HandmadeShopdetils.html?id=${productId}`;
      }

      // إضافة المنتج إلى السلة
      document
        .getElementById("addToCartButtonHandmadeShopdetils")
        .addEventListener("click", function (e) {
          e.preventDefault();
          debugger;
          const userEmail = localStorage.getItem("email");
          const productId = id;
          const productName =
            document.getElementById("productName").textContent;
          const productPrice = parseFloat(
            document
              .getElementById("productPrice")
              .textContent.replace(/[^0-9.]/g, "")
          );
          const productImage = document.getElementById("mainImage").src;
          const currentDate = new Date().toISOString();

          if (userEmail) {
            fetchUserIdAndAddToCart(
              userEmail,
              productId,
              productName,
              productPrice,
              productImage,
              currentDate
            );
          } else {
            addToLocalStorage(
              productId,
              productName,
              productPrice,
              productImage
            );

            Swal.fire({
              title: "تمت إضافة المنتج إلى السلة!",
              text: "يمكنك الذهاب إلى السلة لإتمام عملية الشراء أو مواصلة التسوق.",
              icon: "success",
              showCancelButton: true,
              confirmButtonText: "الذهاب إلى السلة",
              cancelButtonText: "مواصلة التسوق",
              reverseButtons: true,
            }).then((result) => {
              if (result.isConfirmed) {
                window.location.href = "/frontend/user/card.html";
              }
            });
          }
        });

      function addToLocalStorage(
        productId,
        productName,
        productPrice,
        productImage
      ) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const userId = localStorage.getItem("userId") || 0; // Default to 0 if not logged in
        cart.push({
          cardId: userId, // Use userId or 0 as cardId
          productId,
          productName,
          quantity: 1, // افتراض كمية واحدة عند إضافة المنتج للسلة
          productPrice,
          productImage,
          addedAt: new Date().toISOString(),
        });
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      // عند تسجيل الدخول
      function handleLogin() {
        const userEmail = localStorage.getItem("email");

        if (!userEmail) {
          console.error("No email found in localStorage");
          return;
        }

        fetch(`${API_BASE_URL}/Users/email/${encodeURIComponent(userEmail)}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((userData) => {
            debugger;
            const userId = userData.id || userData.userId;
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            console.log("cart", cart);
            if (cart.length > 0) {
              cart.forEach((product) => {
                addToCartAPI(
                  product.productId,
                  product.productName,
                  product.productPrice,
                  product.productImage,
                  product.quantity,
                  product.addedAt,
                  userId
                );
              });
              localStorage.removeItem("cart");
            }
          })
          .catch((error) => {
            console.error("Error fetching user data:", error);
          });
      }

      function fetchUserIdAndAddToCart(
        userEmail,
        productId,
        productName,
        productPrice,
        productImage,
        addedAt
      ) {
        fetch(`${API_BASE_URL}/Users/email/${encodeURIComponent(userEmail)}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((userData) => {
            const userId = userData.id || userData.userId;
            addToCartAPI(
              productId,
              productName,
              productPrice,
              productImage,
              1,
              addedAt,
              userId
            );
          })
          .catch((error) => {
            console.error("Error fetching user data:", error);
          });
      }

      function addToCartAPI(
        productId,
        productName,
        productPrice,
        productImage,
        quantity,
        addedAt,
        userId
      ) {
        // Construct the payload based on API requirements
        const payload = {
          // Assuming 'cartId' is a separate entity. If not, adjust accordingly.
          // Remove 'userId' if 'cartId' suffices
          cartId: userId, // Replace with actual cart identifier if different
          productId: productId,
          quantity: quantity,
          price: productPrice,
          addedAt: addedAt,
          // Remove 'userId' if not required
        };

        console.log("Payload being sent to API:", payload); // For debugging

        fetch(`${API_BASE_URL}/CardItem`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((errorData) => {
                throw new Error(
                  `HTTP error! status: ${response.status}, message: ${
                    errorData.message || "Unknown error"
                  }`
                );
              });
            }
            return response.json();
          })
          .then((cartItem) => {
            Swal.fire({
              title: "تمت إضافة المنتج إلى السلة!",
              text: "يمكنك الذهاب إلى السلة لإتمام عملية الشراء أو مواصلة التسوق.",
              icon: "success",
              showCancelButton: true,
              confirmButtonText: "الذهاب إلى السلة",
              cancelButtonText: "مواصلة التسوق",
              reverseButtons: true,
            });
          })
          .catch((error) => {
            Swal.fire({
              title: "خطأ",
              text: `حدث خطأ أثناء إضافة المنتج للسلة: ${error.message}`,
              icon: "error",
            });
            console.error("Error adding product to cart:", error);
          });
      }
    </script>
  </body>
</html>
