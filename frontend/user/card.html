<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>جدول المنتجات</title>
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/about.css" />
    <link rel="stylesheet" href="css/card.css" />
  </head>
  <body dir="rtl">
    <div class="top-bar">
      <div class="container d-flex justify-content-between flex-wrap">
        <div class="top-bar-left">
          <i class="fas fa-map-marker-alt"></i> الأردن، عجلون
          <i class="fas fa-envelope ms-3"></i> Ideamedia@gmail.com
        </div>
        <div class="top-bar-right d-flex align-items-center">
          <i class="fas fa-phone"></i>
          <a href="tel:+962791234567" class="text-ligth text-decoration-none"
            >0777956583</a
          >
          <span class="ms-3">تابعنا على:</span>
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-whatsapp"></i></a>
          <a href="#"><i class="fab fa-linkedin-in"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <span class="idea">أيديا</span>
          <span class="media">ميديا</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span><i class="fas fa-bars" style="color: orange"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Index.html">الرئيسية</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="coursesDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام الدورات
              </a>
              <ul
                id="categoriesDropdown"
                class="dropdown-menu"
                aria-labelledby="coursesDropdown"
              >
                <!-- سيتم إضافة الأقسام هنا -->
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المتجر
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/equipmentshop.html"
                    >متجر معدات</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/HandmadeShop.html"
                    >متجر منتجات يدوية</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/AllEvents.html"
                >كل الأحداث</a
              >
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المدربين
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/singupInstructors.html"
                  >
                    تسجيل كمدرب</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/ALLInstructors.html"
                    >كل المدربين</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Contact.html"
                >اتصل بنا</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/about.html">من نحن</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/admin/loginAdmin.html"
                >لوحة الإدارة</a
              >
            </li>
          </ul>
          <div class="icon-buttons d-flex align-items-center">
            <!-- زر تسجيل الدخول أو تسجيل الخروج بناءً على حالة تسجيل الدخول -->
            <div id="authLinks"></div>
          </div>
        </div>
      </div>
    </nav>

    <ol class="breadcrumb">
      <li><a href="/">الصفحة الرئيسية</a></li>
      <li>&#10229;</li>
      <li class="active">سلة المشتريات</li>
    </ol>
    <!-- Container -->
    <div class="container mt-5">
      <h1>سلة المشتريات</h1>
      <div class="d-flex one">
        <!-- Products Table (60%) -->
        <div class="container mt-5">
          <table class="table table-bordered" dir="rtl">
            <thead
              class="thead-dark"
              style="background-color: navy; color: white"
            >
              <tr>
                <th scope="col">#</th>
                <th scope="col">اختيار</th>
                <th scope="col">المنتج</th>
                <th scope="col">اسم المنتج</th>
                <th scope="col">سعر الوحدة</th>
                <th scope="col">الكمية</th>
                <th scope="col">أضف إلى السلة</th>
                <th scope="col">إغلاق</th>
              </tr>
            </thead>
            <tbody id="product-table-body">
              <!-- Dynamic Product Rows Go Here -->
            </tbody>
          </table>
        </div>

        <!-- مراحل الدفع -->
        <div class="ml-5 p-3 border rounded" style="flex-basis: 40%">
          <h4 class="text-right font-weight-bold">
            المجموع الإجمالي: <span id="total-price">$0</span>
          </h4>

          <!-- المرحلة 1: إدخال الكوبون -->
          <div id="step-1">
            <div class="form-group">
              <label for="coupon-code">أدخل الكوبون:</label>
              <input
                type="text"
                id="coupon-code"
                class="form-control"
                placeholder="اكتب الكوبون هنا"
              />
              <button id="apply-coupon" class="btn btn-success mt-2 w-100">
                تطبيق الكوبون
              </button>
              <p
                id="coupon-feedback"
                class="text-danger mt-2"
                style="display: none"
              >
                كود الكوبون غير صالح
              </p>
            </div>
          </div>

          <!-- المرحلة 2: اختيار طريقة الدفع (مخفية افتراضياً) -->
          <div id="step-2" style="display: none">
            <h5 class="text-center">اختر طريقة الدفع</h5>
            <button class="btn btn-primary w-100 mb-2">
              <img
                src="https://img.icons8.com/color/24/paypal.png"
                alt="Paypal"
              />
              PayPal
            </button>
            <button class="btn btn-secondary w-100 mb-2">
              <img src="https://img.icons8.com/color/24/visa.png" alt="Visa" />
              بطاقة
            </button>
            <button class="btn btn-dark w-100 mb-2">
              <img
                src="https://img.icons8.com/color/24/mastercard.png"
                alt="MasterCard"
              />
              ماستر كارد
            </button>
          </div>

          <!-- المرحلة 3: تأكيد الطلب (مخفية افتراضياً) -->
          <div id="step-3" style="display: none">
            <h5 class="text-center">تأكيد الطلب</h5>
            <p>
              تم تطبيق الكوبون بنجاح! اخترت طريقة الدفع:
              <span id="selected-payment-method"></span>
            </p>
            <button class="btn btn-success w-100">تأكيد الطلب</button>
          </div>
        </div>
      </div>
    </div>

    <br />
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-column">
            <h5>معلومات عنا</h5>
            <ul>
              <li><a href="#">قصتنا</a></li>
              <li><a href="#">الرؤية والرسالة</a></li>
              <li><a href="#">فريق العمل</a></li>
              <li><a href="#">الوظائف</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>روابط سريعة</h5>
            <ul>
              <li><a href="#">الرئيسية</a></li>
              <li><a href="#">المتجر</a></li>
              <li><a href="#">الأحداث</a></li>
              <li><a href="#">المدربون</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>تواصل معنا</h5>
            <ul>
              <li><a href="#">اتصل بنا</a></li>
              <li><a href="#">الأسئلة الشائعة</a></li>
              <li><a href="#">الدعم الفني</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2023 أيديا ميديا. جميع الحقوق محفوظة.</p>
        </div>
      </div>
    </footer>

    <!-- Bootstrap 5 Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
      let couponApplied = false;
      let discountValue = 0;

      // الكوبونات الصالحة
      const validCoupons = {
        DISCOUNT10: 10, // كوبون يعطي خصم 10%
        SAVE20: 20, // كوبون يعطي خصم 20%
      };

      // زيادة أو تقليل الكمية
      $(document).on("click", ".plus-btn", function () {
        let quantityInput = $(this).siblings(".quantity-input");
        let newValue = parseInt(quantityInput.val()) + 1;
        quantityInput.val(newValue);
        updateTotalPrice($(this).closest("tr"));
        calculateTotal();
      });

      $(document).on("click", ".minus-btn", function () {
        let quantityInput = $(this).siblings(".quantity-input");
        let currentValue = parseInt(quantityInput.val());
        if (currentValue > 1) {
          let newValue = currentValue - 1;
          quantityInput.val(newValue);
          updateTotalPrice($(this).closest("tr"));
          calculateTotal();
        }
      });

      // تحديث السعر الإجمالي بناءً على الكمية
      function updateTotalPrice(row) {
        let pricePerItem = parseFloat(
          row.find(".product-checkbox").data("price")
        );
        let quantity = parseInt(row.find(".quantity-input").val());
        let totalPrice = pricePerItem * quantity;
        row.find(".total-price").text(`$${totalPrice}`);
      }

      // حذف المنتج
      $(document).on("click", ".delete-btn", function () {
        $(this).closest("tr").remove();
        calculateTotal();
      });

      // حساب المجموع الإجمالي
      function calculateTotal() {
        let total = 0;
        $("#productTable tbody tr").each(function () {
          let totalPrice = parseFloat(
            $(this).find(".total-price").text().replace("$", "")
          );
          total += totalPrice;
        });

        // إذا تم تطبيق كوبون خصم
        if (couponApplied) {
          let discount = total * (discountValue / 100);
          total -= discount;
          $("#coupon-feedback")
            .text(`تم تطبيق خصم ${discountValue}%!`)
            .removeClass("text-danger")
            .addClass("text-success")
            .show();
        }

        $("#total-price").text(`$${total.toFixed(2)}`);
      }

      // تطبيق الكوبون
      $("#apply-coupon").on("click", function () {
        let couponCode = $("#coupon-code").val().toUpperCase();
        if (validCoupons[couponCode]) {
          couponApplied = true;
          discountValue = validCoupons[couponCode];
          $("#coupon-feedback").hide();
          calculateTotal();
        } else {
          $("#coupon-feedback")
            .text("كود الكوبون غير صالح")
            .removeClass("text-success")
            .addClass("text-danger")
            .show();
        }
      });

      // تحديث المجموع الإجمالي عند تحميل الصفحة
      calculateTotal();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll(".product-checkbox");
        const totalPriceElement = document.getElementById("total-price");

        function updateTotalPrice() {
          let total = 0;
          checkboxes.forEach((checkbox) => {
            if (checkbox.checked) {
              total += parseFloat(checkbox.dataset.price);
            }
          });
          totalPriceElement.textContent = `$${total}`;
        }

        checkboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updateTotalPrice);
        });
      });
    </script>
    <!-- JavaScript للتحكم في المراحل -->
    <script>
      let totalPrice = 0;

      // Fetch userId using email from the API
      async function fetchUserId() {
        try {
          const email = localStorage.getItem("email");
          console.log("emailNajlaa", email); // Assuming the email is stored in localStorage
          const response = await fetch(
            `http://localhost:38146/api/Users/email/${encodeURIComponent(
              email
            )}`
          );
          const data = await response.json();
          console.log("data147852", data);
          return data.userId; // Assuming the API returns the user object with an "id" property
        } catch (error) {
          console.error("Error fetching user ID:", error);
          return null;
        }
      }
      debugger;
      // Fetch products using productId (e.g., 5 or 2)
      async function fetchProductById(productId) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/Handmade_Products/${productId}`
          );
          const product = await response.json();
          return product;
        } catch (error) {
          console.error(`Error fetching product with ID ${productId}:`, error);
          return null;
        }
      }
      debugger;
      // Fetch and display products
      async function fetchProducts() {
        try {
          const userId = await fetchUserId();
          if (!userId) {
            console.error("User ID not found");
            return;
          }

          const response = await fetch(
            `http://localhost:38146/api/CardItem/user/${userId}`
          );
          const products = await response.json();
          displayProducts(products);
        } catch (error) {
          console.error("Error fetching products:", error);
        }
      }

      // Function to display products in the table
      function displayProducts(products) {
        const tbody = document.getElementById("product-table-body");
        tbody.innerHTML = ""; // Clear existing rows

        products.forEach(async (product, index) => {
          const productDetails = await fetchProductById(product.productId);
          if (!productDetails) return;

          const row = `
            <tr>
                <th scope="row">${index + 1}</th>
                <td><input type="checkbox" name="product${
                  index + 1
                }" class="product-checkbox" data-price="${
            product.price
          }" /></td>
            <td>
  <img src="/backend/image/${productDetails.imageUrl1}" 
       alt="${productDetails.name}" 
       class="product-image" 
       style="width: 100%; max-width: 150px; height: auto;" />
</td>

                <td>${productDetails.name}</td>
                <td>${product.price}$</td>
                <td>
                    <div class="input-group">
                        <button class="btn btn-light border quantity-decrease" data-index="${index}">-</button>
                        <input type="text" class="form-control text-center product-quantity" value="${
                          product.quantity
                        }" style="width: 50px" />
                        <button class="btn btn-light border quantity-increase" data-index="${index}">+</button>
                    </div>
                </td>
                <td><button class="btn btn-warning add-to-cart" data-price="${
                  product.price
                }">أضف إلى السلة</button></td>
                <td><button class="btn btn-danger remove-product"><i class="fa fa-times"></i></button></td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        setupEventListeners();
      }

      // Setup event listeners for buttons
      function setupEventListeners() {
        const addToCartButtons = document.querySelectorAll(".add-to-cart");
        const quantityIncreaseButtons =
          document.querySelectorAll(".quantity-increase");
        const quantityDecreaseButtons =
          document.querySelectorAll(".quantity-decrease");

        addToCartButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const price = parseFloat(this.getAttribute("data-price"));
            addToCart(price);
          });
        });

        quantityIncreaseButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const input = this.previousElementSibling;
            input.value = parseInt(input.value) + 1;
          });
        });

        quantityDecreaseButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const input = this.nextElementSibling;
            if (parseInt(input.value) > 1) {
              input.value = parseInt(input.value) - 1;
            }
          });
        });
      }

      // Add item to cart and update total price
      function addToCart(price) {
        totalPrice += price;
        document.getElementById(
          "total-price"
        ).innerText = `$${totalPrice.toFixed(2)}`;
      }

      // Coupon application logic
      document
        .getElementById("apply-coupon")
        .addEventListener("click", function () {
          const couponCode = document.getElementById("coupon-code").value;

          if (couponCode === "DISCOUNT10") {
            totalPrice *= 0.9; // Apply 10% discount
            document.getElementById(
              "total-price"
            ).innerText = `$${totalPrice.toFixed(2)}`;
            document.getElementById("coupon-feedback").style.display = "none";
          } else {
            document.getElementById("coupon-feedback").style.display = "block";
          }
        });

      // Load products on page load
      window.onload = fetchProducts;
    </script>

    <script src="/frontend/user/javascript/ordelogin.js"></script>
    <script src="/frontend/user/ALLCategories.js"></script>
  </body>
</html>
