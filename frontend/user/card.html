<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>جدول المنتجات</title>
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/about.css" />
    <link rel="stylesheet" href="css/card.css" />
  </head>
  <body dir="rtl">
    <div class="top-bar">
      <div class="container d-flex justify-content-between flex-wrap">
        <div class="top-bar-left">
          <i class="fas fa-map-marker-alt"></i> الأردن، عجلون
          <i class="fas fa-envelope ms-3"></i> Ideamedia@gmail.com
        </div>
        <div class="top-bar-right d-flex align-items-center">
          <i class="fas fa-phone"></i>
          <a href="tel:+962791234567" class="text-ligth text-decoration-none"
            >0777956583</a
          >
          <span class="ms-3">تابعنا على:</span>
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-whatsapp"></i></a>
          <a href="#"><i class="fab fa-linkedin-in"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <span class="idea">أيديا</span>
          <span class="media">ميديا</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span><i class="fas fa-bars" style="color: orange"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Index.html">الرئيسية</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="coursesDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام الدورات
              </a>
              <ul
                id="categoriesDropdown"
                class="dropdown-menu"
                aria-labelledby="coursesDropdown"
              >
                <!-- سيتم إضافة الأقسام هنا -->
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المتجر
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/equipmentshop.html"
                    >متجر معدات</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/HandmadeShop.html"
                    >متجر منتجات يدوية</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                اداره الاحداث
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a class="dropdown-item" href="/frontend/user/postEvents.html"
                    >اضافة أحداث
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/frontend/user/AllEvents.html"
                    >كل الأحداث</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المدربين
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/singupInstructors.html"
                  >
                    تسجيل كمدرب</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/ALLInstructors.html"
                    >كل المدربين</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Contact.html"
                >اتصل بنا</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/about.html">من نحن</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/admin/loginAdmin.html"
                >لوحة الإدارة</a
              >
            </li>
          </ul>
          <div class="icon-buttons d-flex align-items-center">
            <!-- زر تسجيل الدخول أو تسجيل الخروج بناءً على حالة تسجيل الدخول -->
            <div id="authLinks"></div>
          </div>
        </div>
      </div>
    </nav>

    <ol class="breadcrumb">
      <li><a href="/">الصفحة الرئيسية</a></li>
      <li>&#10229;</li>
      <li class="active">سلة المشتريات</li>
    </ol>
    <!-- Container -->
    <div class="container mt-5">
      <h1>سلة المشتريات</h1>
      <div class="d-flex one">
        <!-- Handmade Products Table -->
        <div class="container mt-5">
          <h3>منتجات مصنوعة يدويًا</h3>
          <table class="table table-bordered" dir="rtl">
            <thead
              class="thead-dark"
              style="background-color: navy; color: white"
            >
              <tr>
                <th scope="col">#</th>
                <th scope="col">صورة المنتج</th>
                <th scope="col">اسم المنتج</th>
                <th scope="col">سعر الوحدة</th>
                <th scope="col">الكمية</th>
                <th scope="col">إغلاق</th>
              </tr>
            </thead>
            <tbody id="handmade-product-table-body">
              <!-- Handmade Products Rows Go Here -->
            </tbody>
          </table>
        </div>

        <!-- Learning Equipment Products Table -->
        <div class="container mt-5">
          <h3>معدات التعليم</h3>
          <table class="table table-bordered" dir="rtl">
            <thead
              class="thead-dark"
              style="background-color: navy; color: white"
            >
              <tr>
                <th scope="col">#</th>
                <th scope="col">صورة المنتج</th>
                <th scope="col">اسم المنتج</th>
                <th scope="col">سعر الوحدة</th>
                <th scope="col">الكمية</th>
                <th scope="col">إغلاق</th>
              </tr>
            </thead>
            <tbody id="learning-equipment-table-body">
              <!-- Learning Equipment Rows Go Here -->
            </tbody>
          </table>
        </div>

        <!-- Local Products Table -->
        <div class="container mt-5">
          <h3>المنتجات المحلية</h3>
          <table class="table table-bordered" dir="rtl">
            <thead
              class="thead-dark"
              style="background-color: navy; color: white"
            >
              <tr>
                <th scope="col">#</th>
                <th scope="col">صورة المنتج</th>
                <th scope="col">اسم المنتج</th>
                <th scope="col">سعر الوحدة</th>
                <th scope="col">الكمية</th>
                <th scope="col">إغلاق</th>
              </tr>
            </thead>
            <tbody id="local-product-table-body">
              <!-- Local Products Rows Go Here -->
            </tbody>
          </table>
        </div>

        <!-- المجموع الكلي -->
        <div class="ml-5 p-3 border rounded" style="flex-basis: 40%">
          <h4 class="text-right font-weight-bold">
            المجموع الإجمالي: <span id="total-price">$0</span>
          </h4>
        </div>
      </div>
    </div>

    <script>
      let totalPrice = 0;
      let couponApplied = false;
      let discountValue = 0;

      // Define valid coupons
      const validCoupons = {
        DISCOUNT10: 10,
        SAVE20: 20,
      };

      // Fetch user ID from the API using the email stored in localStorage
      async function fetchUserId() {
        try {
          const email = localStorage.getItem("email");
          if (!email) return null;
          const response = await fetch(
            `http://localhost:38146/api/Users/email/${encodeURIComponent(
              email
            )}`
          );
          const data = await response.json();
          return data.userId;
        } catch (error) {
          console.error("Error fetching user ID:", error);
          return null;
        }
      }

      // Fetch handmade products
      async function fetchHandmadeProducts(userID) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/CardItemHandmadeProduct/card/${userID}`
          );
          return await response.json();
        } catch (error) {
          console.error("Error fetching handmade products:", error);
          return [];
        }
      }

      // Fetch learning equipment
      async function fetchLearningEquipment(userID) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/CardItemLearningEquipment/card/${userID}`
          );
          return await response.json();
        } catch (error) {
          console.error("Error fetching learning equipment:", error);
          return [];
        }
      }

      // Fetch additional product details
      async function fetchProductDetails(productId, category) {
        const url =
          category === "Handmade"
            ? `http://localhost:38146/api/Handmade_Products/${productId}`
            : `http://localhost:38146/api/LearningEquipment/${productId}`;

        return await fetchProduct(url);
      }

      // General fetch function
      async function fetchProduct(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          return await response.json();
        } catch (error) {
          console.error("Error fetching product details:", error);
          return null;
        }
      }

      // Display products in a specific table
      async function displayProducts(products, tableBodyId) {
        const tbody = document.getElementById(tableBodyId);
        tbody.innerHTML = ""; // Clear table

        for (let index = 0; index < products.length; index++) {
          const product = products[index];
          const productId = product.equipmentId || product.productId;
          const category = product.category;
          let productName = product.productName || product.name;
          let imageUrl = product.product?.imageUrl1 || product.imageUrl1;

          if (!productName || !imageUrl) {
            const productDetails = await fetchProductDetails(
              productId,
              category
            );
            if (productDetails) {
              productName = productDetails.name || productName;
              imageUrl = productDetails.imageUrl1 || "default-image.jpg";
            } else {
              imageUrl = "default-image.jpg";
            }
          }

          const productPrice = product.productPrice || product.price || 0;
          const row = `
            <tr data-product-id="${productId}" data-category="${category}">
              <td>${index + 1}</td>
              <td><img src="/backend/image/${imageUrl}" alt="${productName}" style="width: 100px; height: auto;" /></td>
              <td>${productName}</td>
              <td class="unit-price">${productPrice} JD</td>
              <td>${product.quantity}</td>
              <td><button class="btn btn-danger remove-product"><i class="fa fa-times"></i></button></td>
            </tr>
          `;
          tbody.innerHTML += row;
        }
      }

      // Load products from both APIs and localStorage
      async function loadProducts() {
        const userID = await fetchUserId(); // Get userID if logged in

        let handmadeProducts = [],
          learningEquipment = [],
          localStorageProducts = [];

        if (userID) {
          handmadeProducts = await fetchHandmadeProducts(userID);
          learningEquipment = await fetchLearningEquipment(userID);
        }

        // Get products from localStorage
        localStorageProducts = JSON.parse(localStorage.getItem("cart")) || [];

        // Display Handmade Products
        await displayProducts(handmadeProducts, "handmade-product-table-body");
        // Display Learning Equipment
        await displayProducts(
          learningEquipment,
          "learning-equipment-table-body"
        );
        // Display Local Products
        await displayProducts(localStorageProducts, "local-product-table-body");

        // Update total price
        updateTotalPrice();
      }

      // Update total price calculation
      function updateTotalPrice() {
        let total = 0;
        document
          .querySelectorAll(".unit-price")
          .forEach(function (priceElement) {
            total += parseFloat(priceElement.textContent.replace(" JD", ""));
          });

        document.getElementById("total-price").textContent = `$${total.toFixed(
          2
        )}`;
      }

      // Load products when the page is loaded
      window.onload = loadProducts;
    </script>

    <br />
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-column">
            <h5>معلومات عنا</h5>
            <ul>
              <li><a href="#">قصتنا</a></li>
              <li><a href="#">الرؤية والرسالة</a></li>
              <li><a href="#">فريق العمل</a></li>
              <li><a href="#">الوظائف</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>روابط سريعة</h5>
            <ul>
              <li><a href="#">الرئيسية</a></li>
              <li><a href="#">المتجر</a></li>
              <li><a href="#">الأحداث</a></li>
              <li><a href="#">المدربون</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>تواصل معنا</h5>
            <ul>
              <li><a href="#">اتصل بنا</a></li>
              <li><a href="#">الأسئلة الشائعة</a></li>
              <li><a href="#">الدعم الفني</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2023 أيديا ميديا. جميع الحقوق محفوظة.</p>
        </div>
      </div>
    </footer>

    <!-- Bootstrap 5 Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <!-- <script>
      let totalPrice = 0;
      let couponApplied = false;
      let discountValue = 0;

      const validCoupons = {
        DISCOUNT10: 10,
        SAVE20: 20,
      };

      // استرجاع userID من API باستخدام email المخزن في localStorage
      async function fetchUserId() {
        try {
          const email = localStorage.getItem("email");
          if (!email) return null; // إذا لم يكن هناك تسجيل دخول
          const response = await fetch(
            `http://localhost:38146/api/Users/email/${encodeURIComponent(
              email
            )}`
          );
          const data = await response.json();
          return data.userId;
        } catch (error) {
          console.error("Error fetching user ID:", error);
          return null;
        }
      }

      // استرجاع المنتجات اليدوية من API باستخدام userID
      async function fetchHandmadeProducts(userID) {
        debugger;
        try {
          const response = await fetch(
            `http://localhost:38146/api/CardItemHandmadeProduct/card/${userID}`
          );
          const products = await response.json();
          return products;
        } catch (error) {
          console.error("Error fetching handmade products from API:", error);
          return [];
        }
      }

      // استرجاع المعدات التعليمية من API باستخدام userID
      async function fetchLearningEquipment(userID) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/CardItemLearningEquipment/card/${userID}`
          );
          const products = await response.json();
          return products;
        } catch (error) {
          console.error("Error fetching learning equipment from API:", error);
          return [];
        }
      }

      // استرجاع تفاصيل المنتج اليدوي باستخدام productId
      async function fetchHandmadeProductDetails(productId) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/Handmade_Products/${productId}`
          );
          const productDetails = await response.json();
          return productDetails;
        } catch (error) {
          console.error("Error fetching handmade product details:", error);
          return null;
        }
      }

      // استرجاع تفاصيل المعدات التعليمية باستخدام equipmentId
      async function fetchLearningEquipmentDetails(equipmentId) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/LearningEquipment/${equipmentId}`
          );
          const productDetails = await response.json();
          return productDetails;
        } catch (error) {
          console.error("Error fetching learning equipment details:", error);
          return null;
        }
      }

      // عرض المنتجات في الجدول
      async function displayProducts(products) {
        const tbody = document.getElementById("product-table-body");
        tbody.innerHTML = ""; // تنظيف الجدول

        for (let index = 0; index < products.length; index++) {
          const product = products[index];

          let productDetails;

          // جلب تفاصيل المنتج بناءً على الفئة
          if (product.category === "Handmade") {
            productDetails = await fetchHandmadeProductDetails(
              product.productId
            );
          } else if (product.category === "LearningEquipment") {
            productDetails = await fetchLearningEquipmentDetails(
              product.equipmentId
            );
          } else {
            productDetails = product; // من localStorage
          }

          if (!productDetails) continue;

          // بناء الصف لعرض المنتج
          const row = `
                  <tr>
                      <th scope="row">${index + 1}</th>
                      <td><img src="/backend/image/${
                        productDetails.imageUrl
                      }" alt="${
            productDetails.productName
          }" style="width: 100px; height: auto;" /></td>
                      <td>${productDetails.productName}</td>
                      <td class="unit-price">${product.price}JD</td>
                      <td>${product.quantity}</td>
                      <td><button class="btn btn-danger remove-product"><i class="fa fa-times"></i></button></td>
                  </tr>
              `;
          tbody.innerHTML += row;
        }
        setupEventListeners();
      }

      // تحميل المنتجات عند فتح الصفحة
      async function loadProducts() {
        const userID = await fetchUserId();

        let allProducts = [];

        if (userID) {
          const handmadeProducts = await fetchHandmadeProducts(userID);
          const learningEquipment = await fetchLearningEquipment(userID);

          // دمج المنتجات اليدوية والمعدات التعليمية في مصفوفة واحدة
          allProducts = [
            ...handmadeProducts.map((product) => ({
              ...product,
              category: "Handmade",
            })),
            ...learningEquipment.map((product) => ({
              ...product,
              category: "LearningEquipment",
            })),
          ];
        }

        // إضافة المنتجات من localStorage
        const localStorageProducts =
          JSON.parse(localStorage.getItem("cart")) || [];
        allProducts = [
          ...allProducts,
          ...localStorageProducts.map((product) => ({
            ...product,
            category: "Local",
          })),
        ];

        // عرض جميع المنتجات
        await displayProducts(allProducts);

        // تحديث السعر الإجمالي
        updateTotalPrice();
      }

      // إعداد المستمعين للأحداث
      function setupEventListeners() {
        document.querySelectorAll(".remove-product").forEach(function (btn) {
          btn.addEventListener("click", function () {
            this.closest("tr").remove();
            updateTotalPrice();
          });
        });
      }

      // تحديث السعر الإجمالي
      function updateTotalPrice() {
        let total = 0;
        document
          .querySelectorAll(".unit-price")
          .forEach(function (priceElement) {
            total += parseFloat(priceElement.textContent.replace("JD", ""));
          });

        if (couponApplied) {
          let discount = total * (discountValue / 100);
          total -= discount;
        }

        document.getElementById("total-price").textContent = `$${total.toFixed(
          2
        )}`;
      }

      // تطبيق الكوبون
      function applyCoupon(couponCode) {
        const discount = validCoupons[couponCode.toUpperCase()];
        if (discount) {
          discountValue = discount;
          couponApplied = true;
          updateTotalPrice();
          alert(`Coupon applied! You saved ${discount}%`);
        } else {
          alert("Invalid coupon code.");
        }
      }

      // دالة لتطبيق الكوبون
      document
        .getElementById("apply-coupon")
        .addEventListener("click", function () {
          const couponCode = document.getElementById("coupon-code").value;
          applyCoupon(couponCode);
        });

      // تنفيذ دالة تحميل المنتجات عند تحميل الصفحة
      window.onload = loadProducts;
    </script> -->
    <!-- <script src="/frontend/user/card.js"></script> -->

    <script src="/frontend/user/javascript/ordelogin.js"></script>
    <script src="/frontend/user/ALLCategories.js"></script>
  </body>
</html>
