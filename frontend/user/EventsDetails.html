<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تفاصيل الحدث</title>
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/about.css" />
  </head>
  <body dir="rtl">
    <div class="top-bar">
      <div class="container d-flex justify-content-between flex-wrap">
        <div class="top-bar-left">
          <i class="fas fa-map-marker-alt"></i> الأردن، عجلون
          <i class="fas fa-envelope ms-3"></i> Ideamedia@gmail.com
        </div>
        <div class="top-bar-right d-flex align-items-center">
          <i class="fas fa-phone"></i>
          <a href="tel:+962791234567" class="text-ligth text-decoration-none"
            >0777956583</a
          >
          <span class="ms-3">تابعنا على:</span>
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-whatsapp"></i></a>
          <a href="#"><i class="fab fa-linkedin-in"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <span class="idea">أيديا</span>
          <span class="media">ميديا</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span><i class="fas fa-bars" style="color: orange"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Index.html">الرئيسية</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="coursesDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام الدورات
              </a>
              <ul
                id="categoriesDropdown"
                class="dropdown-menu"
                aria-labelledby="coursesDropdown"
              >
                <!-- سيتم إضافة الأقسام هنا -->
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المتجر
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/equipmentshop.html"
                    >متجر معدات</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/HandmadeShop.html"
                    >متجر منتجات يدوية</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/AllEvents.html"
                >كل الأحداث</a
              >
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="storeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                أقسام المدربين
              </a>
              <ul class="dropdown-menu" aria-labelledby="storeDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/singupInstructors.html"
                  >
                    تسجيل كمدرب</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="/frontend/user/ALLInstructors.html"
                    >كل المدربين</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/Contact.html"
                >اتصل بنا</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/user/about.html">من نحن</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/frontend/admin/loginAdmin.html"
                >لوحة الإدارة</a
              >
            </li>
          </ul>
          <div class="icon-buttons d-flex align-items-center">
            <!-- زر تسجيل الدخول أو تسجيل الخروج بناءً على حالة تسجيل الدخول -->
            <div id="authLinks"></div>
          </div>
        </div>
      </div>
    </nav>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="index.html">الصفحة الرئيسية</a>
        </li>
        <li class="breadcrumb-item">
          <a href="allevents.html">جميع الأحداث</a>
        </li>
        <li
          class="breadcrumb-item active"
          aria-current="page"
          id="title-event-nav"
        >
          ندوة فنون الخياطة الأساسية والتقنيات المتقدمة مع محترفي الصناعة
        </li>
      </ol>
    </nav>
    <div class="row">
      <div class="col-lg-8">
        <div class="card mb-3">
          <img
            id="eventImage"
            src="/backend/image/default.png"
            class="card-img-top"
            alt="صورة الحدث"
          />
          <div class="card-body">
            <h2 id="eventTitle" class="card-title"></h2>
            <p>
              <i class="fas fa-calendar-alt"></i> <span id="eventDate"></span> |
              <i class="fas fa-map-marker-alt"></i>
              <span id="eventLocation"></span> | <i class="fas fa-users"></i>
              <span id="eventParticipants"></span>
            </p>
            <p>بواسطة <span id="eventSpeaker"></span></p>
            <p id="eventSummary"></p>
            <h3>ما الذي ستتعلمه في هذا الحدث:</h3>
            <ul id="eventLearnings"></ul>
            <h3>أربع مميزات رئيسية نقدمها في هذا الحدث:</h3>
            <p id="eventFeatures"></p>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <button
              id="joinButton"
              class="btn btn-warning"
              onclick="toggleJoin()"
            >
              انضم لهذا الحدث
            </button>

            <ul class="list-group list-group-flush mt-4">
              <li id="eventDateList" class="list-group-item"></li>
              <li id="eventTimeList" class="list-group-item"></li>
              <li id="eventTopicsList" class="list-group-item"></li>
              <li id="eventExamsList" class="list-group-item"></li>
              <li id="eventArticlesList" class="list-group-item"></li>
              <li id="eventCertificatesList" class="list-group-item"></li>
              <li id="eventSeatsList" class="list-group-item"></li>
            </ul>
            <div class="map mt-4">
              <iframe
                id="eventMap"
                width="100%"
                height="200"
                frameborder="0"
                style="border: 0"
                allowfullscreen=""
                aria-hidden="false"
                tabindex="0"
              ></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-column">
            <h5>معلومات عنا</h5>
            <ul>
              <li><a href="#">قصتنا</a></li>
              <li><a href="#">الرؤية والرسالة</a></li>
              <li><a href="#">فريق العمل</a></li>
              <li><a href="#">الوظائف</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>روابط سريعة</h5>
            <ul>
              <li><a href="#">الرئيسية</a></li>
              <li><a href="#">المتجر</a></li>
              <li><a href="#">الأحداث</a></li>
              <li><a href="#">المدربون</a></li>
            </ul>
          </div>
          <div class="col-md-4 footer-column">
            <h5>تواصل معنا</h5>
            <ul>
              <li><a href="#">اتصل بنا</a></li>
              <li><a href="#">الأسئلة الشائعة</a></li>
              <li><a href="#">الدعم الفني</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2023 أيديا ميديا. جميع الحقوق محفوظة.</p>
        </div>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

    <!-- Bootstrap 5 Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="/frontend/user/javascript/ordelogin.js"></script>
    <script src="/frontend/user/ALLCategories.js"></script>

    <script>
      // جلب معرف الطالب من البريد الإلكتروني
      async function getStudentIdByEmail(email) {
        try {
          const response = await fetch(
            `http://localhost:38146/api/Users/api/Users/email/${encodeURIComponent(
              email
            )}`
          );

          if (!response.ok) {
            throw new Error(
              `فشل في جلب معرف الطالب، الحالة: ${response.status}`
            );
          }

          const data = await response.json();
          console.log("استجابة API:", data); // لعرض محتوى الاستجابة

          if (!data.studentId) {
            throw new Error("لم يتم العثور على معرف الطالب في استجابة API");
          }

          return data.studentId;
        } catch (error) {
          console.error("خطأ أثناء جلب معرف الطالب:", error);
          throw error;
        }
      }
      // وظيفة التبديل بين الانضمام وإلغاء الانضمام
      // async function toggleJoin() {
      //   debugger;
      //   const email = localStorage.getItem("email"); // جلب البريد الإلكتروني من التخزين المحلي
      //   const eventId = localStorage.getItem("EventID"); // جلب معرف الحدث من التخزين المحلي
      //   const button = document.getElementById("joinButton");

      //   console.log("البريد الإلكتروني:", email); // Debug: Check email value

      //   if (email) {
      //     try {
      //       // جلب معرف الطالب باستخدام البريد الإلكتروني
      //       const studentId = await getStudentIdByEmail(email);

      //       if (!studentId) {
      //         throw new Error("لم يتم العثور على معرف الطالب");
      //       }

      //       if (button.classList.contains("btn-warning")) {
      //         // إزالة الكلاس الذي يخص اللون الأصفر
      //         button.classList.remove("btn-warning");

      //         // إضافة الكلاس الذي يخص اللون الأخضر
      //         button.classList.add("btn-success");

      //         // تغيير النص داخل الزر
      //         button.textContent = "تم الانضمام";

      //         // تعطيل الزر بعد الضغط عليه لمنعه من العمل مرة أخرى
      //         button.disabled = true;
      //         // حفظ حالة الانضمام في localStorage
      //         localStorage.setItem("joined", "true");

      //         swal({
      //           title: "تم الانضمام!",
      //           text: "لقد انضممت إلى هذا الحدث بنجاح.",
      //           icon: "success",
      //           button: "موافق",
      //         });

      //         // جلب التاريخ الحالي للحجز
      //         const bookingDate = new Date().toISOString().split("T")[0];

      //         // إنشاء بيانات الطلب
      //         const bodyData = {
      //           StudentId: studentId,
      //           EventId: eventId,
      //           BookingDate: bookingDate,
      //           Status: "Confirmed",
      //         };

      //         // إرسال طلب POST
      //         // إرسال POST request كـ JSON
      //         const response = await fetch(
      //           "http://localhost:38146/api/Booking/api/Booking",
      //           {
      //             method: "POST",
      //             headers: {
      //               "Content-Type": "application/json",
      //             },
      //             body: JSON.stringify(bodyData),
      //           }
      //         );

      //         if (!response.ok) {
      //           throw new Error("فشل في إنشاء الحجز");
      //         }

      //         const data = await response.json();
      //         console.log("تم الحجز بنجاح:", data);
      //       } else {
      //       }
      //     } catch (error) {
      //       console.error("خطأ أثناء عملية الحجز:", error);
      //       swal({
      //         title: "خطأ",
      //         text: "حدث خطأ أثناء الانضمام للحدث. حاول مرة أخرى.",
      //         icon: "error",
      //         button: "موافق",
      //       });
      //     }
      //   } else {
      //     swal({
      //       title: "تسجيل الدخول مطلوب",
      //       text: "يرجى تسجيل الدخول أولاً.",
      //       icon: "warning",
      //       button: "تسجيل الدخول",
      //     }).then(() => {
      //       window.location.href = "/frontend/user/login.html";
      //     });
      //   }
      // }
      async function toggleJoin() {
        debugger;
        const email = localStorage.getItem("email"); // جلب البريد الإلكتروني من التخزين المحلي
        const eventId = localStorage.getItem("EventID"); // جلب معرف الحدث من التخزين المحلي
        const button = document.getElementById("joinButton");

        console.log("البريد الإلكتروني:", email); // Debug: Check email value

        if (email) {
          try {
            // جلب معرف الطالب باستخدام البريد الإلكتروني
            const studentId = await getStudentIdByEmail(email);

            if (!studentId) {
              throw new Error("لم يتم العثور على معرف الطالب");
            }

            if (button.classList.contains("btn-warning")) {
              // إزالة الكلاس الذي يخص اللون الأصفر
              button.classList.remove("btn-warning");

              // إضافة الكلاس الذي يخص اللون الأخضر
              button.classList.add("btn-success");

              // تغيير النص داخل الزر
              button.textContent = "تم الانضمام";

              // تعطيل الزر بعد الضغط عليه لمنعه من العمل مرة أخرى
              button.disabled = true;

              // إخفاء الزر بعد الانضمام
              button.style.display = "none";

              // حفظ حالة الانضمام في localStorage
              localStorage.setItem("joined", "true");

              // رسالة نجاح باستخدام SweetAlert
              swal({
                title: "تم الانضمام!",
                text: "لقد انضممت إلى هذا الحدث بنجاح.",
                icon: "success",
                button: "موافق",
              });

              // جلب التاريخ الحالي للحجز
              const bookingDate = new Date().toISOString().split("T")[0];

              // إنشاء بيانات الطلب
              const bodyData = {
                StudentId: studentId,
                EventId: eventId,
                BookingDate: bookingDate,
                Status: "Confirmed",
              };

              // إرسال طلب POST
              const response = await fetch(
                "http://localhost:38146/api/Booking/api/Booking",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(bodyData),
                }
              );

              if (!response.ok) {
                throw new Error("فشل في إنشاء الحجز");
              }

              const data = await response.json();
              console.log("تم الحجز بنجاح:", data);
            }
          } catch (error) {
            console.error("خطأ أثناء عملية الحجز:", error);
            swal({
              title: "خطأ",
              text: "حدث خطأ أثناء الانضمام للحدث. حاول مرة أخرى.",
              icon: "error",
              button: "موافق",
            });
          }
        } else {
          swal({
            title: "تسجيل الدخول مطلوب",
            text: "يرجى تسجيل الدخول أولاً.",
            icon: "warning",
            button: "تسجيل الدخول",
          }).then(() => {
            window.location.href = "/frontend/user/login.html";
          });
        }
      }

      // جلب تفاصيل الحدث باستخدام EventID
      const eventId = localStorage.getItem("EventID");

      if (eventId) {
        fetch(`http://localhost:38146/api/Event/${eventId}`)
          .then((response) => response.json())
          .then((event) => {
            // تحديث العنوان والصورة
            document.getElementById("eventTitle").textContent =
              event.eventTitle;
            document.getElementById("title-event-nav").textContent =
              event.eventTitle;
            document.getElementById("eventImage").src = `/backend/image/${
              event.imagePath || "default.png"
            }`;

            // تحديث تفاصيل الحدث في الوصف
            document.getElementById("eventDate").textContent = new Date(
              event.eventDate
            ).toLocaleDateString("ar-SA");
            document.getElementById("eventLocation").textContent =
              event.location;
            document.getElementById(
              "eventParticipants"
            ).textContent = `${event.participants} مشارك`;
            document.getElementById("eventSpeaker").textContent = event.speaker;
            document.getElementById("eventSummary").textContent = event.summary;

            // تحديث التعليمات والميزات
            document.getElementById("eventLearnings").innerHTML =
              event.learnings
                .split(", ")
                .map((item) => `<li>${item}</li>`)
                .join("");
            document.getElementById("eventFeatures").textContent =
              event.features;

            // تحديث العناصر التفصيلية
            document.getElementById(
              "eventDateList"
            ).textContent = `التاريخ: ${new Date(
              event.eventDate
            ).toLocaleDateString("ar-SA")}`;
            document.getElementById(
              "eventTimeList"
            ).textContent = `وقت البدء: ${event.eventTime}`;
            document.getElementById(
              "eventTopicsList"
            ).textContent = `عدد المواضيع: ${event.topics}`;
            document.getElementById(
              "eventExamsList"
            ).textContent = `عدد الاختبارات: ${event.exams}`;
            document.getElementById(
              "eventArticlesList"
            ).textContent = `المقالات: ${event.articles}`;
            document.getElementById(
              "eventCertificatesList"
            ).textContent = `الشهادات: ${event.certificates}`;
            document.getElementById(
              "eventSeatsList"
            ).textContent = `عدد المقاعد: ${event.seatsAvailable}`;

            // تحديث الموقع على الخريطة
            document.getElementById(
              "eventMap"
            ).src = `https://www.google.com/maps?q=${encodeURIComponent(
              event.location
            )}&output=embed`;
          })
          .catch((error) => {
            console.error("خطأ في جلب تفاصيل الحدث:", error);
          });
      } else {
        console.error("لم يتم العثور على EventID في التخزين المحلي.");
      }
    </script>
  </body>
</html>
